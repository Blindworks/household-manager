<div class="consumption-charts">
  <div class="container">
    <header class="consumption-charts__header">
      <div>
        <p class="consumption-charts__eyebrow">Verbrauchsverlauf</p>
        <h1 class="consumption-charts__title">Verbraeuche als Graph</h1>
        <p class="consumption-charts__subtitle">
          Anzeige des Verbrauchs pro Ablesung. KW-Vergleich folgt spaeter.
        </p>
      </div>
      <div class="consumption-charts__legend">
        <app-icon [name]="getIconName()" class="consumption-charts__icon"></app-icon>
        <span>{{ getSelectedLabel() }}</span>
      </div>
    </header>

    <section class="consumption-charts__controls">
      <div class="consumption-charts__tabs" role="tablist">
        @for (type of meterTypes; track type) {
          <button
            type="button"
            class="consumption-charts__tab"
            [class.consumption-charts__tab--active]="selectedType === type"
            (click)="selectType(type)">
            {{ MeterTypeUtils.getLabel(type) }}
          </button>
        }
      </div>
      <div class="consumption-charts__controls-right">
        <label class="consumption-charts__select">
          <span>Jahr</span>
          <select (change)="setYear($any($event.target).value)">
            <option value="ALL" [selected]="selectedYear === 'ALL'">Alle Jahre</option>
            @for (year of availableYears; track year) {
              <option [value]="year" [selected]="selectedYear === year">{{ year }}</option>
            }
          </select>
        </label>
        @if (selectedYear !== 'ALL') {
          <label class="consumption-charts__select">
            <span>Monat</span>
            <select (change)="setMonth($any($event.target).value)">
              <option value="ALL" [selected]="selectedMonth === 'ALL'">Alle Monate</option>
              @for (month of availableMonths; track month) {
                <option [value]="month" [selected]="selectedMonth === month">{{ month }}</option>
              }
            </select>
          </label>
        }
        <div class="consumption-charts__view-toggle">
          <button
            type="button"
            class="consumption-charts__view"
            [class.consumption-charts__view--active]="!compareMode"
            (click)="setCompareMode(false)">
            Einzelansicht
          </button>
          <button
            type="button"
            class="consumption-charts__view"
            [class.consumption-charts__view--active]="compareMode"
            (click)="setCompareMode(true)">
            Vergleich
          </button>
        </div>
      </div>
    </section>

    @if (isLoading) {
      <div class="consumption-charts__state">Laedt Diagramm...</div>
    } @else if (errorMessage) {
      <div class="consumption-charts__state consumption-charts__state--error">{{ errorMessage }}</div>
    } @else {
      @if (!compareMode && selectedSeries?.points?.length) {
        <div class="consumption-charts__card">
          <div class="consumption-charts__chart-header">
            <div>
              <p class="consumption-charts__chart-title">
                Verbrauchsverlauf: {{ getSelectedLabel() }}
              </p>
              <p class="consumption-charts__chart-subtitle">
                Einheit: {{ getSelectedUnit() }} pro Intervall
              </p>
            </div>
            <div class="consumption-charts__chart-meta">
              <span>Ablesungen: {{ selectedSeries?.points?.length }}</span>
            </div>
          </div>

          <div class="consumption-charts__chart">
            <div
              echarts
              class="consumption-charts__echart"
              [options]="singleChartOptions"></div>
          </div>

        </div>
      } @else if (compareMode) {
        <div class="consumption-charts__compare">
          <div class="consumption-charts__compare-controls">
            <div class="consumption-charts__compare-block">
              <span class="consumption-charts__compare-title">Vergleich A</span>
              <div class="consumption-charts__compare-selects">
                <label class="consumption-charts__select">
                  <span>Jahr</span>
                  <select (change)="setCompareYearA($any($event.target).value)">
                    <option value="ALL" [selected]="compareYearA === 'ALL'">Alle Jahre</option>
                    @for (year of availableYears; track year) {
                      <option [value]="year" [selected]="compareYearA === year">{{ year }}</option>
                    }
                  </select>
                </label>
                @if (compareYearA !== 'ALL') {
                  <label class="consumption-charts__select">
                    <span>Monat</span>
                    <select (change)="setCompareMonthA($any($event.target).value)">
                      <option value="ALL" [selected]="compareMonthA === 'ALL'">Alle Monate</option>
                      @for (month of getAvailableMonthsFor(compareYearA); track month) {
                        <option [value]="month" [selected]="compareMonthA === month">{{ month }}</option>
                      }
                    </select>
                  </label>
                }
              </div>
            </div>
            <div class="consumption-charts__compare-block">
              <span class="consumption-charts__compare-title">Vergleich B</span>
              <div class="consumption-charts__compare-selects">
                <label class="consumption-charts__select">
                  <span>Jahr</span>
                  <select (change)="setCompareYearB($any($event.target).value)">
                    <option value="ALL" [selected]="compareYearB === 'ALL'">Alle Jahre</option>
                    @for (year of availableYears; track year) {
                      <option [value]="year" [selected]="compareYearB === year">{{ year }}</option>
                    }
                  </select>
                </label>
                @if (compareYearB !== 'ALL') {
                  <label class="consumption-charts__select">
                    <span>Monat</span>
                    <select (change)="setCompareMonthB($any($event.target).value)">
                      <option value="ALL" [selected]="compareMonthB === 'ALL'">Alle Monate</option>
                      @for (month of getAvailableMonthsFor(compareYearB); track month) {
                        <option [value]="month" [selected]="compareMonthB === month">{{ month }}</option>
                      }
                    </select>
                  </label>
                }
              </div>
            </div>
          </div>

          <div class="consumption-charts__card">
            <div class="consumption-charts__chart-header">
              <div>
                <p class="consumption-charts__chart-title">Vergleich A</p>
                <p class="consumption-charts__chart-subtitle">
                  Einheit: {{ getSelectedUnit() }} pro Intervall
                </p>
              </div>
            </div>
            @if (compareSeriesAValue.points.length) {
              <div class="consumption-charts__chart">
                <div
                  echarts
                  class="consumption-charts__echart"
                  [options]="compareChartOptionsA"></div>
              </div>
            } @else {
              <div class="consumption-charts__state">
                Keine Daten fuer Vergleich A.
              </div>
            }
          </div>

          <div class="consumption-charts__card">
            <div class="consumption-charts__chart-header">
              <div>
                <p class="consumption-charts__chart-title">Vergleich B</p>
                <p class="consumption-charts__chart-subtitle">
                  Einheit: {{ getSelectedUnit() }} pro Intervall
                </p>
              </div>
            </div>
            @if (compareSeriesBValue.points.length) {
              <div class="consumption-charts__chart">
                <div
                  echarts
                  class="consumption-charts__echart"
                  [options]="compareChartOptionsB"></div>
              </div>
            } @else {
              <div class="consumption-charts__state">
                Keine Daten fuer Vergleich B.
              </div>
            }
          </div>
        </div>
      } @else {
        <div class="consumption-charts__state">
          Noch nicht genug Ablesungen fuer einen Verlauf.
        </div>
      }
    }
  </div>
</div>
